#!/bin/bash
## Comment:		Helper to update some emacs major-mode.
##
## Project:
## Started by		Melvin Laplanche <melvin.laplanche+dev@gmail.com>
## On			06/27/2011, 06:42 PM
## Last updated by	Melvin Laplanche <melvin.laplanche+dev@gmail.com>
## On			June 29 2011 at 10:40 PM

# Usage : $? message_if_fail [message_if_ok]
function __update_emacs_check_return() {
    if [ $# -ne 2 ] || [ $# -ne 3 ]; then
	return 1
    fi
    if [ $1 -ne 0 ]; then
	if [ -z $3 ]; then
	    put_info $3
	fi
	return 0
    else
	put_error $2
	return 0
    fi
}

function update_emacs() {
    local pwd_save=`pwd`
    local repo_path=/tmp/emacs-save
    local autoload_path=~/.emacs.d/autoloadable

    mkdir -fp $repo_path
    if [ $? -ne 0 ]; then
	put_error "$repo_path not writable"
	return 0;
    fi
    rm -Rf $repo_path
    cd "/tmp"

    put_info "Retrieving pkgbuild-mode"
    git clone https://github.com/juergenhoetzel/pkgbuild-mode.git \
	$repo_path/pkgbuild
    __update_emacs_check_return $? "fail" "done"

    put_info "Retrieving android-mode"
    git clone https://github.com/remvee/android-mode.git \
	$repo_path/android-mode
    __update_emacs_check_return $? "fail" "done"

    put_info "Retrieving django-mode"
    git clone https://github.com/myfreeweb/django-mode.git \
	$repo_path/django-mode
    if [ $? -ne 0 ]; then
	put_info -n "Updating snippets... "
	cp -Rf $repo_path/django-mode/snippets/* ~/.emacs.d/snippets/
	__update_emacs_check_return $? "fail" "done"
	put_info "done"
    else
	put_error "fail"
    fi

    put_info "Retrieving egg"
    git clone https://github.com/bogolisk/egg.git \
	$repo_path/egg
    __update_emacs_check_return $? "fail" "done"

    put_info "Retrieving yaml-mode"
    git clone https://github.com/yoshiki/yaml-mode.git \
	$repo_path/yaml-mode
    __update_emacs_check_return $? "fail" "done"

    put_info "Retrieving cmake-mode"
    mkdir $repo_path/cmake-mode
    wget -O $repo_path/cmake-mode/cmake-mode.el \
	"http://www.cmake.org/CMakeDocs/cmake-mode.el"
    __update_emacs_check_return $? "fail" "done"
    
     # Add other mode HERE

    put_info -n "Updating all retrieved mode... "
    cp $repo_path/*/*.el $autoload_path/
    __update_emacs_check_return $? "fail" "done"

    put_info "Updating python-mode"
    git clone https://github.com/emacsmirror/python-mode.git \
	$repo_path/python-mode
    if [ $? -ne 0 ]; then
	cp $repo_path/python-mode/python-mode.el $autoload_path/
	__update_emacs_check_return $? "fail" "done"
    else
	put_error "fail"
    fi
    
    put_info "Updating python-mode done"

    put_info "Updating html5-el..."
    cd $autoload_path/html5-el
    git pull origin master
    hg clone https://bitbucket.org/validator/syntax/ $repo_path/syntax
    rm -Rf relaxng
    mv $repo_path/syntax/relaxng .
    cd /tmp
    put_info "Updating html5-el done"

    put_info "Updating yasnippet"
    svn checkout http://yasnippet.googlecode.com/svn/trunk/ \
	$repo_path/yasnippet
    cp $repo_path/yasnippet/yasnippet.el $autoload_path/
    cp $repo_path/yasnippet/dropdown-list.el $autoload_path/
    put_info "Updating yasnippet done"
    
    put_info "Updating nxhtml"
    cd $autoload_path/nxhtml
    bzr merge
    #bzr branch lp:nxhtml $repo_path/nxhtml
    __update_emacs_check_return $? "fail" "done"
    cd "/tmp"

    put_error "The following modes are not auto-updated: "
    echo -e "cmake-mode\nnpov-mode"
    
    rm -Rf $repo_path
    cd $pwd_save
}
